var mysql=require("mysql");var express=require("express");var app=express();var morgan=require("morgan");var bodyParser=require("body-parser");var methodOverride=require("method-override");var Config=require("config-js");var config=new Config("config/configuracija.js");var dbcon=mysql.createPool({connectionLimit:config.get("sequel.conlimt"),host:config.get("sequel.link"),user:config.get("sequel.juzer"),password:config.get("sequel.lozinka"),database:config.get("sequel.baza"),port:config.get("sequel.prt")});var ver=config.get("ver.dev");console.log("*********************************************\nserver version "+ver+"\n*********************************************\n*********************************************\ninitial components loaded\n*********************************************\n");app.use("/scripts",express["static"]("./node_modules/"));app.use("/angular",express["static"]("./frontend/angular/"));app.use("/images",express["static"]("./views/images/"));app.use("/views",express["static"]("./views/"));app.use(bodyParser.json());app.use(bodyParser.urlencoded({extended:true}));app.get("/",function(b,a){console.log("This is req.url: ",b.url);a.sendFile(__dirname+"/views/index.html")});app.get("/api/vehicles",function(b,a){console.log("API GET getAllVehicles");getAllVehicles(function(c){a.send(c)})});app.post("/api/vehicles",function(b,a){console.log("API POST createNewVehicle");createNewVehicle(b.body,function(c){a.send(c)})});app.get("/api/users",function(b,a){console.log("API GET getAllUsers");getAllUsers(function(c){a.send(c)})});app.post("/api/users",function(b,a){console.log("API POST createNewUser");createNewUser(b.body,function(c){a.send(c)})});testDataBaseConnection(function(a){if(a){console.log("SERVER: Connection to the database established... ")}else{console.log("ERROR")}});app.listen(80,function(){console.log(ver," Initialization sequence complete. ");console.log("********************************************* "+new Date()," - vms server started listening on port:80 *********************************************")});function testDataBaseConnection(a){dbcon.getConnection(function(c,b){dbcon.query("SELECT 1+0 AS selection",function(d,e){if(d){if(d.fatal){console.log("Processor: ",new Date(),"Doslo je do prekida komunikacije sa bazom podataka");throw d}console.error("Processor: ",new Date(),"Could not connect to the db. Check if the DB is running?",d.code,d.fatal);a(false)}else{console.log("Processor: ",new Date(),"Connection successful",e[0].selection);console.log("Processor: Database is set.");a(true)}});b.release()})}function getAllVehicles(a){results=[];dbcon.getConnection(function(c,b){b.query(config.get("vhl.slt"),function(d,e){if(d){if(d.fatal){throw d}console.error("Processor: getAllVehicles: List of vehicles",new Date(),config.get("poruke.konNaBazu"),d.code,d.fatal)}results=e;ritrn=JSON.stringify(results);a(ritrn)});b.release()})}function getAllUsers(a){results=[];dbcon.getConnection(function(c,b){b.query(config.get("usr.slt"),function(d,e){if(d){if(d.fatal){throw d}console.error("Processor: getAllUsers: List of users",new Date(),config.get("poruke.konNaBazu"),d.code,d.fatal)}results=e;ritrn=JSON.stringify(results);a(ritrn)});b.release()})}function createNewUser(a,b){results=[];console.log("POST: createNewUser: Incoming from client: ",a);dbcon.getConnection(function(d,c){console.log(a.user);c.query(config.get("usr.ins"),[a.user],function(e,f){if(e){if(e.fatal){throw e}console.error("Processor: createNewUser: Insert new user",new Date(),config.get("poruke.konNaBazu"),e.code,e.fatal)}results=f;console.log("createNewUser -> results: ",results);ritrn=JSON.stringify(results);b(ritrn)});c.release()})};